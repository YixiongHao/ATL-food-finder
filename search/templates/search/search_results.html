{% extends 'map/base.html' %}
{% block content %}

<div id="map" style="height: 500px; width: 100%;"></div>
    
<h1>Nearby Restaurants</h1>
<ul>
{% for place in results %}
    <li>
        <h2>{{ place.name }}</h2>
        <p>Address: {{ place.vicinity }}</p>
        <p>Rating: {{ place.rating }}</p>
    </li>
{% empty %}
    <li>No restaurants found nearby.</li>
{% endfor %}
</ul>
    
<script>
    let map;
    let userLocation;

    function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
            zoom: 12,
            center: {lat: 0, lng: 0}  // Default center, will be updated
        });

        // Try to get user's location
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    map.setCenter(userLocation);
                    
                    // Add a marker for user's location
                    new google.maps.Marker({
                        position: userLocation,
                        map: map,
                        title: "Your Location"
                    });

                    // You can send this location to your Django view using AJAX
                    sendLocationToServer(userLocation);
                },
                () => {
                    handleLocationError(true, map.getCenter());
                }
            );
        } else {
            handleLocationError(false, map.getCenter());
        }
    }

    function handleLocationError(browserHasGeolocation, pos) {
        // Handle error (e.g., show a message to the user)
    }

    function sendLocationToServer(location) {
        fetch('/your-view-url/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(location)
        })
        .then(response => response.json())
        .then(data => {
            // Handle the response from the server
        });
    }

    // Function to get CSRF token
    function getCookie(name) {
        // Implementation to get CSRF token from cookies
    }

    window.initMap = initMap;
</script>

<script src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&callback=initMap" async defer></script>

{% endblock content %}