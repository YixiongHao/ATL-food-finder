{% extends 'map/base.html' %}
{% block content %}

<div>
    <div class="frame1">
        <div class="search-bar">
            <form action="{% url 'search' %}" method="GET">
            <input type="text" name="query" placeholder="Search..." class="search-input">
            <button type="submit" class="search-icon">üîéÔ∏é</button>
            </form>
        </div>
        {% if not request.user.is_authenticated %}
            <a class="login" href="{% url 'login' %}">Login</a>
        {% else %}
            <a class="login" href="{% url 'logout' %}">Log Out</a>
            <button class="account-button" onclick=window.location.href="{% url 'favorites' %}">Account</button>
        {% endif %}
    </div>
    <div class="sidebar-search" id="sidebar">
        <div class="model">
            <button class="close-button" onclick=window.location.href="{% url 'map' %}">‚®â</button>
            <div class="model-header"></div>
            <form id="filterRadius" method="GET" action="{% url 'search' %}">
                <div class="filter-section">
                    <h3>Distance</h3>
                    <div class="radio-group">
                        <label class="radio">
                            <input type="radio" name="radius" value="50000" {% if radius == '50000' %}checked{% endif %}>
                            <span>Any</span>
                        </label>
                        <label class="radio">
                            <input type="radio" name="radius" value="1609" {% if radius == '1609' %}checked{% endif %}>
                            <span><1 mi</span>
                        </label>
                        <label class="radio">
                            <input type="radio" name="radius" value="8045" {% if radius == '8045' %}checked{% endif %}>
                            <span><5 mi</span>
                        </label>
                        <label class="radio">
                            <input type="radio" name="radius" value="16090" {% if radius == '16090' %}checked{% endif %}>
                            <span><10 mi</span>
                        </label>
                        <label class="radio">
                            <input type="radio" name="radius" value="32180" {% if radius == '32180' %}checked{% endif %}>
                            <span><20 mi</span>
                        </label>
                    </div>
                </div>
            </form>
            <form id="filterRating" method="GET" action="{% url 'search' %}">
                <div class="filter-section">
                    <h3>Rating</h3>
                    <div class="radio-group">
                        <label class="radio">
                            <input type="radio" name="min_rating" value="0" {% if min_rating == '0' %}checked{% endif %}>
                            <span>Any</span>
                        </label>
                        <label class="radio">
                            <input type="radio" name="min_rating" value="4" {% if min_rating == '4' %}checked{% endif %}>
                            <span>>4 <span class="star-text">‚òÖ</span></span>
                        </label>
                        <label class="radio">
                            <input type="radio" name="min_rating" value="3" {% if min_rating == '3' %}checked{% endif %}>
                            <span>>3 <span class="star-text">‚òÖ</span></span>
                        </label>
                        <label class="radio">
                            <input type="radio" name="min_rating" value="2" {% if min_rating == '2' %}checked{% endif %}>
                            <span>>2 <span class="star-text">‚òÖ</span></span>
                        </label>
                        <label class="radio">
                            <input type="radio" name="min_rating" value="1" {% if min_rating == '1' %}checked{% endif %}>
                            <span>>1 <span class="star-text">‚òÖ</span></span>
                        </label>
                    </div>
                </div>
            </form>
            <div class="results">
                {% for place in results %}
                    <div class="result-card">
                        <div class="result-header">
                            <h3><a href="/../details/{{ place.id }}?cuisine_type={{ place.cuisine }}">{{ place.displayName.text }}</a></h3>
                            <span class="distance">{{ place.distance }} mi</span>
                        </div>
                        <div class="result-details">
                            <div class="rating">
                                <span>{{ place.rating }}</span>
                                <div class="stars">
                                    {% for i in "12345" %}
                                        <span class="star {% if forloop.counter <= place.rating %}filled{% endif %}"></span>
                                    {% endfor %}
                                </div>
                            </div>
                            <span class="cuisine">{{ place.cuisine }}</span>
                        </div>
                        <button class="favorite-button">‚ô°</button> <!-- or ‚ù§Ô∏é if favorited -->
                        <p class="description">{{ place.formattedAddress }}</p>
                    </div>
                {% empty %}
                    <p>No restaurants found nearby.</p>
                {% endfor %}
            </div>
        </div>
    </div>
    <div id="map"></div>

</div>

<script>
    let map;
    let userLocation;

    function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
            zoom: 12,
            center: {lat: 0, lng: 0},  // Default center, will be updated
            fullscreenControl: true,  // Enable fullscreen control
            fullscreenControlOptions: {
                position: google.maps.ControlPosition.LEFT_TOP  // Fullscreen control at the top
            },
            mapTypeControlOptions: {
                position: google.maps.ControlPosition.LEFT_CENTER  // Map type controls under fullscreen
            },
            streetViewControlOptions: {
                position: google.maps.ControlPosition.LEFT_BOTTOM  // Street view controls below map type
            },
            zoomControlOptions: {
                position: google.maps.ControlPosition.LEFT_BOTTOM  // Zoom controls at the bottom
            }
        });

        // Try to get user's location
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    map.setCenter(userLocation);

                    // Add a marker for user's location
                    new google.maps.Marker({
                        position: userLocation,
                        map: map,
                        title: "Your Location"
                    });

                    // You can send this location to your Django view using AJAX
                    sendLocationToServer(userLocation);
                },
                () => {
                    handleLocationError(true, map.getCenter());
                }
            );
        } else {
            handleLocationError(false, map.getCenter());
        }
    }

    function handleLocationError(browserHasGeolocation, pos) {
        // Handle error (e.g., show a message to the user)
    }

    function sendLocationToServer(location) {
        fetch('/your-view-url/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(location)
        })
        .then(response => response.json())
        .then(data => {
            // Handle the response from the server
        });
    }

    // Function to get CSRF token
    function getCookie(name) {
        // Implementation to get CSRF token from cookies
    }

    window.initMap = initMap;
</script>

<script>
    function closeSidebar(){
        document.getElementById('sidebar').style.display = 'none';
    }

    function openSidebar(term){
        // use search term OR pass in keyword (*FAVES*) to open to favorites
        var header = document.getElementsByClassName("model-header")[0];
        if (term === "*FAVES*") {
            header.innerHTML = "<h2>Favorites</h2>"
        } else {
            header.innerHTML = "<h2>Search Results</h2>"
        }
        document.getElementById('sidebar').style.display = 'block';
    }

    // favorite button behavior needs to be implemented ‚ô°‚ù§

    document.addEventListener("DOMContentLoaded", openSidebar());
    document.addEventListener("DOMContentLoaded", function () {
        this.title = "Search Results - ATL Food Finder";
    });

</script>

<script src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&callback=initMap" async defer></script>

<script>
//for filter radio boxes
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('filterRadius');
    const radioButtons = form.querySelectorAll('input[type="radio"]');

    // Get the current radius from the URL
    const urlParams = new URLSearchParams(window.location.search);
    const currentRadius = urlParams.get('radius') || '50000'; // Default to 50000 if not set

    // Set the correct radio button as checked
    radioButtons.forEach(function(radio) {
        if (radio.value === currentRadius) {
            radio.checked = true;
        }
    });

    radioButtons.forEach(function(radio) {
        radio.addEventListener('change', function() {
            // Get all current URL parameters
            const urlParams = new URLSearchParams(window.location.search);

            // Update or add the radius parameter
            urlParams.set('radius', this.value);

            // Construct the new URL and navigate to it
            window.location.href = window.location.pathname + '?' + urlParams.toString();
        });
    });
});

//for rating radio boxes
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('filterRating');
    const radioButtons = form.querySelectorAll('input[type="radio"]');

    // Get the current rating from the URL
    const urlParams = new URLSearchParams(window.location.search);
    const currentRating = urlParams.get('min_rating') || '0'; // Default to 500000 if not set

    // Set the correct radio button as checked
    radioButtons.forEach(function(radio) {
        if (radio.value === currentRating) {
            radio.checked = true;
        }
    });

    radioButtons.forEach(function(radio) {
        radio.addEventListener('change', function() {
            // Get all current URL parameters
            const urlParams = new URLSearchParams(window.location.search);

            // Update or add the rating parameter
            urlParams.set('min_rating', this.value);

            // Construct the new URL and navigate to it
            window.location.href = window.location.pathname + '?' + urlParams.toString();
        });
    });
});
</script>

{% endblock content %}
