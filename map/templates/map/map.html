{% extends 'map/base.html' %}
{% block content %}
{% load static %}

<script>
    let map;
    let service;
    let infowindow;
    let userLocationMarker;
    let userLocation;
    let searches = ['american_restaurant', 'bakery', 'bar', 'barbecue_restaurant', 'brazilian_restaurant',
    'breakfast_restaurant', 'brewpub', 'brunch_restaurant', 'cafe', 'chinese_restaurant', 'coffee_shop', 'fast_food_restaurant',
    'french_restaurant', 'greek_restaurant', 'hamburger_restaurant', 'ice_cream_shop', 'indian_restaurant',
    'indonesian_restaurant', 'italian_restaurant', 'japanese_restaurant', 'korean_restaurant', 'lebanese_restaurant',
    'meal_delivery', 'meal_takeaway', 'mediterranean_restaurant', 'mexican_restaurant', 'middle_eastern_restaurant',
    'pizza_restaurant', 'ramen_restaurant', 'restaurant', 'sandwich_shop', 'seafood_restaurant', 'spanish_restaurant',
    'steak_house', 'sushi_restaurant', 'thai_restaurant', 'turkish_restaurant', 'vegan_restaurant', 'vegetarian_restaurant',
    'vietnamese_restaurant',];

    function initMap() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition((position) => {
                userLocation = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };

                // Initialize the map centered at the user's location
                map = new google.maps.Map(document.getElementById('map'), {
                    zoom: 12,
                    center: userLocation
                });

                infowindow = new google.maps.InfoWindow();
                service = new google.maps.places.PlacesService(map);

                // Add a special marker for the user's current location
                addUserLocationMarker(userLocation);

                // Perform search queries near the user's location
                for (let i = 0; i < searches.length; i++) {
                    const request = {
                        query: searches[i],
                        location: userLocation,
                        radius: 15000  // 15 km radius
                    };
                    service.textSearch(request, (results, status) => {
                        if (status === google.maps.places.PlacesServiceStatus.OK && results) {
                            for (let i = 0; i < results.length; i++) {
                                createMarker(results[i]);
                                restaurantsData.push({  // Create Restaurant model for each search result
                                    name: results[i].name,
                                    address: results[i].formatted_address,
                                    geometry: results[i].geometry,
                                    place_id: results[i].place_id
                                });
                            }

                            const formData = new FormData();
                            restaurantsData.forEach(restaurant => {
                                formData.append('restaurants', JSON.stringify(restaurant)); // Append each restaurant as a JSON string
                            });

                            // Send restaurant data to Django backend
                            fetch('/save-restaurants/', {
                                method: 'POST',
                                headers: {
                                    'X-CSRFToken': getCookie('csrftoken')  // Use a function to get CSRF token
                                },
                                body: formData
                            })
                            .then(response => response.json())
                            .catch(error => console.error('Error:', error));
                        } else {
                            console.log('No restaurant data to send.');
                        }
                    });
                }
            }, () => {
                const fallbackLocation = { lat: 33.7488, lng: -84.3877 };  // Fallback to Atlanta
                map = new google.maps.Map(document.getElementById('map'), {
                    zoom: 12,
                    center: fallbackLocation
                });
                handleLocationError(true, fallbackLocation);
            });
        } else {
            const fallbackLocation = { lat: 33.7488, lng: -84.3877 };  // Fallback to Atlanta
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 12,
                center: fallbackLocation
            });
            handleLocationError(false, fallbackLocation);
        }

        // Initialize map in the center of Atlanta
        const atlantaCenter = new google.maps.LatLng(33.7488, -84.3877);
        map = new google.maps.Map(document.getElementById('map'), {
            zoom: 11,
            center: atlantaCenter
        });

        infowindow = new google.maps.InfoWindow();

        // Iterate over every food/drink type to obtain all search results
        // TODO: max of 20 restaurants from each search result. How do we get more?
        service = new google.maps.places.PlacesService(map);
        for (let i = 0; i < searches.length; i++) {
            const request = {
                query: searches[i],
                location: atlantaCenter,

            };
            const restaurantsData = []; // This list is populated with Restaurant models
            service.textSearch(request, (results, status) => {
                if (status === google.maps.places.PlacesServiceStatus.OK && results) {
                    for (let i = 0; i < results.length; i++) {
                        createMarker(results[i]);
                        restaurantsData.push({  // Create Restaurant model for each search result
                            name: results[i].name,
                            address: results[i].formatted_address,
                            geometry: results[i].geometry,
                            place_id: results[i].place_id
                        });
                    }

                    const formData = new FormData();
                    restaurantsData.forEach(restaurant => {
                        formData.append('restaurants', JSON.stringify(restaurant)); // Append each restaurant as a JSON string
                    });

                    // Send restaurant data to Django backend
                    fetch('/save-restaurants/', {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': getCookie('csrftoken')  // Use a function to get CSRF token
                        },
                        body: formData
                    })
                    .then(response => response.json())
                    .catch(error => console.error('Error:', error));
                } else {
                    console.log('No restaurant data to send.');
                }
            });
        }
    }

    // Function to add a special marker for the user's current location
    function addUserLocationMarker(location) {
        userLocationMarker = new google.maps.Marker({
            position: location,
            map: map,
            title: "You are here",
            icon: {
                url: "https://maps.google.com/mapfiles/ms/icons/blue-dot.png",  // A blue dot for user's location
                scaledSize: new google.maps.Size(40, 40)  // Resize the marker icon
            }
        });

        // Open an info window when the user clicks on their location marker
        google.maps.event.addListener(userLocationMarker, "click", () => {
            infowindow.setContent("You are here");
            infowindow.open(map, userLocationMarker);
        });
    }

    // Function to calculate the distance between two geographic points using the Haversine formula
    function calculateDistance(lat1, lng1, lat2, lng2) {
        const R = 6371; // Radius of the Earth in kilometers
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLng = (lng2 - lng1) * Math.PI / 180;
        const a =
            Math.sin(dLat / 2) * Math.sin(dLat / 2) +
            Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
            Math.sin(dLng / 2) * Math.sin(dLng / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        const distance = R * c; // Distance in kilometers
        return distance;
    }

    function handleLocationError(browserHasGeolocation, pos) {
        infowindow = new google.maps.InfoWindow();
        infowindow.setPosition(pos);
        infowindow.setContent(browserHasGeolocation ?
            'Error: The Geolocation service failed.' :
            'Error: Your browser doesn\'t support geolocation.');
        infowindow.open(map);
    }

    function createMarker(place) {
        if (!place.geometry || !place.geometry.location) {
            return;
        }

        const marker = new google.maps.Marker({
            map: map,
            position: place.geometry.location,
            title: place.name
        });

        google.maps.event.addListener(marker, "click", () => {
            // Use Place Details API to get more information about the place
            const request = {
                placeId: place.place_id,
                fields: ['name', 'formatted_address', 'rating', 'reviews', 'geometry']
            };

            /*
             * Should be included in details:
             * Restaurant name
             * Address
             * Link to details page
             * Option to add to favorites
             */
            service.getDetails(request, (placeDetails, status) => {
                if (status === google.maps.places.PlacesServiceStatus.OK && placeDetails) {
                    // Prepare the reviews content
                    let reviewsContent = '';
                    if (placeDetails.reviews && placeDetails.reviews.length > 0) {
                        reviewsContent = placeDetails.reviews.slice(0, 3).map(review => `
                            <p><strong>${review.author_name}</strong>: ${review.text}</p>
                        `).join('');
                    } else {
                        reviewsContent = 'No reviews available';
                    }

                    // Calculate distance between user and the marker's location
                    const distance = calculateDistance(
                        userLocation.lat,
                        userLocation.lng,
                        placeDetails.geometry.location.lat(),
                        placeDetails.geometry.location.lng()
                    ).toFixed(2);  // Display distance up to 2 decimal places

                    // Create the content string including distance
                    const content = `
                        <strong>${placeDetails.name}</strong><br>
                        ${placeDetails.formatted_address}<br>
                        <strong>Rating:</strong> ${placeDetails.rating || 'No rating available'}<br>
                        <strong>Reviews:</strong><br>
                        ${reviewsContent}<br>
                        <strong>Distance from your location:</strong> ${distance} km
                    `;

                    // Set content and open info window
                    infowindow.setContent(content);
                    infowindow.open(map, marker);
                } else {
                    console.log("Failed to get place details: ", status);
                }
            });
        });
    }

    // Function used to obtain CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // Check if this cookie string begins with the name we want
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }


    window.initMap = initMap;
</script>

<div class="pageholder">
    <div class="linkholder">
        <div class="mapholder">
            {% if not request.user.is_authenticated %}
            <a class="login" href="{% url 'login' %}">Login</a>
            {% else %}
            <a class="login" href="{% url 'logout' %}">Log Out</a>
            {% endif %}

            <div id="map" style="height: 500px; width: 100%;"></div>
            <script
            src="https://maps.googleapis.com/maps/api/js?key={{ key }}&callback=initMap&libraries=places"
            defer
            ></script>
        </div>
    </div>
</div>

{% endblock content %}
