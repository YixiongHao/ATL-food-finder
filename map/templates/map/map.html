{% extends 'map/base.html' %}
{% block content %}
{% load static %}

<script>
    let map;
    let service;
    let infowindow;
    let userLocationMarker;
    let userLocation;
    let markers = []; // Track markers to clear them
    let searches = ['american_restaurant', 'bakery', 'bar', 'barbecue_restaurant', 'brazilian_restaurant',
    'breakfast_restaurant', 'brewpub', 'brunch_restaurant', 'cafe', 'chinese_restaurant', 'coffee_shop', 'fast_food_restaurant',
    'french_restaurant', 'greek_restaurant', 'hamburger_restaurant', 'ice_cream_shop', 'indian_restaurant',
    'indonesian_restaurant', 'italian_restaurant', 'japanese_restaurant', 'korean_restaurant', 'lebanese_restaurant',
    'meal_delivery', 'meal_takeaway', 'mediterranean_restaurant', 'mexican_restaurant', 'middle_eastern_restaurant',
    'pizza_restaurant', 'ramen_restaurant', 'restaurant', 'sandwich_shop', 'seafood_restaurant', 'spanish_restaurant',
    'steak_house', 'sushi_restaurant', 'thai_restaurant', 'turkish_restaurant', 'vegan_restaurant', 'vegetarian_restaurant',
    'vietnamese_restaurant'];
    let key = '{{ key }}';

    function initMap() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition((position) => {
                userLocation = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };

                // Initialize the map centered at the user's location
                map = new google.maps.Map(document.getElementById('map'), {
                    zoom: 12,
                    center: userLocation
                });

                infowindow = new google.maps.InfoWindow();
                service = new google.maps.places.PlacesService(map);

                // Add user location marker
                addUserLocationMarker(userLocation);

                // Perform initial restaurant search based on zoom level
                updateRestaurants();

                // Add zoom change listener to dynamically update restaurants as the user zooms
                google.maps.event.addListener(map, 'zoom_changed', () => {
                    clearMarkers(); // Clear old markers
                    updateRestaurants(); // Add new restaurants based on zoom level
                });
            }, () => {
                const fallbackLocation = { lat: 33.7488, lng: -84.3877 }; // Fallback to Atlanta
                handleLocationError(true, fallbackLocation);
            });
        } else {
            const fallbackLocation = { lat: 33.7488, lng: -84.3877 }; // Fallback to Atlanta
            handleLocationError(false, fallbackLocation);
        }
    }

    // Update restaurants dynamically based on zoom level
    function updateRestaurants() {
        const zoomLevel = map.getZoom();
        let radius;

        // Dynamically adjust the radius based on the zoom level
        if (zoomLevel >= 15) {
            radius = 1000; // 1 km for detailed zoom
        } else if (zoomLevel >= 12) {
            radius = 5000; // 5 km for moderate zoom
        } else if (zoomLevel >= 9) {
            radius = 15000; // 15 km for further out
        } else {
            radius = 30000; // 30 km for wide zoom
        }

        for (let i = 0; i < searches.length; i++) {
            const url = `/search/?query=${encodeURIComponent(searches[i])}&location=${encodeURIComponent(userLocation)}&radius=${radius}`;

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.results) {
                        data.results.forEach(place => {
                            createMarker(place, searches[i]);
                        });
                    }
                })
                .catch(error => console.error('Error:', error));
        }
    }

    // Clear all markers from the map
    function clearMarkers() {
        for (let i = 0; i < markers.length; i++) {
            markers[i].setMap(null); // Remove marker from map
        }
        markers = []; // Clear marker array
    }

    // Create a new marker for each restaurant
    function createMarker(place, cuisineType) {
        if (!place.geometry || !place.geometry.location) return;

        const marker = new google.maps.Marker({
            map: map,
            position: place.geometry.location,
            title: place.name
        });

        markers.push(marker); // Add marker to global array

        google.maps.event.addListener(marker, 'click', () => {
            let reviewsContent = '';
            if (place.reviews && place.reviews.length > 0) {
                reviewsContent = place.reviews.slice(0, 3).map(review => `
                    <p><strong>${review.author_name}</strong>: ${review.text}</p>
                `).join('');
            } else {
                reviewsContent = 'No reviews available';
            }

            const distance = calculateDistance(
                userLocation.lat,
                userLocation.lng,
                place.geometry.location.lat,
                place.geometry.location.lng
            ).toFixed(2);

            cuisineType = cuisineType.replace('_', ' ');

            const content = `
                <button id="favorite-${place.place_id}" class="favorite-btn">Favorite</button>
                <strong>${place.name}</strong><br>
                ${place.formatted_address}<br>
                <a href="/details/${place.place_id}/">Details</a><br>
                <strong>Cuisine:</strong> ${cuisineType}<br>
                <strong>Rating:</strong> ${place.rating || 'No rating available'}<br>
                <strong>Distance from your location:</strong> ${distance} km<br>
                <strong>Reviews:</strong> ${reviewsContent}
            `;

            infowindow.setContent(content);
            infowindow.open(map, marker);

            google.maps.event.addListener(marker, "click", () => {
                service = new google.maps.places.PlacesService(map);
                const request = {
                    placeId: place.place_id,
                    fields: ['name', 'formatted_address', 'rating', 'reviews', 'types', 'geometry']
                };
                const lat = place.geometry.location.lat;
                const lng = place.geometry.location.lng;
                favoriteRestaurant(place.place_id, place.name, place.formatted_address, lat, lng);
            });
        });
    }

    // Add a marker for the user's current location
    function addUserLocationMarker(location) {
        userLocationMarker = new google.maps.Marker({
            position: location,
            map: map,
            title: "You are here",
            icon: {
                url: "https://maps.google.com/mapfiles/ms/icons/blue-dot.png",
                scaledSize: new google.maps.Size(40, 40)
            }
        });
    }

    function calculateDistance(lat1, lng1, lat2, lng2) {
        const R = 6371; // Radius of the Earth in km
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLng = (lng2 - lng1) * Math.PI / 180;
        const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                  Math.sin(dLng / 2) * Math.sin(dLng / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
    }

    function handleLocationError(browserHasGeolocation, pos) {
        infowindow.setPosition(pos);
        infowindow.setContent(browserHasGeolocation ?
            'Error: The Geolocation service failed.' :
            'Error: Your browser doesn\'t support geolocation.');
        infowindow.open(map);
    }

    function favoriteRestaurant(placeId, name, address, lat, lng) {
        const csrfToken = getCookie('csrftoken');  // Retrieve CSRF token from cookies


        // Data to send to the backend
        const formData = new FormData();
        formData.append('place_id', placeId);
        formData.append('name', name);
        formData.append('address', address);
        formData.append('lat', lat);
        formData.append('lng', lng);


        // Send a POST request to your Django backend
        fetch('/favorite-restaurant/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json' // Make sure to set the content type if sending JSON
            },
            body: JSON.stringify({
                place_id: placeId, // replace with the actual variable containing place ID
                name: name,
                address: address,
                lat: lat,
                lng: lng
            })
        })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.error); // Throw an error to handle it later
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    alert(`${name} has been added to your favorites!`);
                } else {
                    alert('Error: Could not add to favorites.');
                }
            })
            .catch(error => {
                alert(error.message); // Show the error message returned from the server
            });
    }

    // Utility function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // Check if this cookie string begins with the name we want
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    window.initMap = initMap;
</script>

<div class="pageholder">
    <div class="linkholder">
        <div class="mapholder">
            <div class="frame1">
                    <div class="search-bar">
                        <form action="{% url 'search' %}" method="GET">
                            <input type="text" name = "query" placeholder="Search..." class="search-input">
                            <button class="search-icon">🔎︎</button>
                        </form>
                    </div>
                    {% if not request.user.is_authenticated %}
                        <a class="login" href="{% url 'login' %}">Login</a>
                    {% else %}
                        <a class="login" href="{% url 'logout' %}">Log Out</a>
                        <button class="account-button" onclick='openSidebar("*FAVES*")'>Account</button> <!-- should be a var -->
                    {% endif %}
                </div>
            <div id="map"></div>
            <script
                src="https://maps.googleapis.com/maps/api/js?key={{ key }}&callback=initMap&libraries=places"
                defer
            ></script>
        </div>
    </div>
</div>

{% endblock content %}
